{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"metadata": {
		"comments": "Setup automated Email notifications to alert on required/monitored digital Assets and vulnerabilities  from your MD EASM Inventory",
		"author": "EASM GTP CxE Team"
	},
	"parameters": {
		"workflows_MDEASM_EmailAlerts_name": {
			"defaultValue": "MDEASM-EmailAlerts",
			"type": "String"
		},
		"EASM API Access Token": {
			"defaultValue": "Bearer Token",
			"type": "String"
		},
		"EASM URI": {
			"defaultValue": "https://southcentralus.easm.defender.microsoft.com/subscriptions/:subscriptionId/resourceGroups/:resourceGroupName/workspaces/:workspaceName/assets",
			"type": "String"
		},
		"EASM query filter": {
			"defaultValue": "state = \"Approved\"",
			"type": "String"
		},
		"EmailRecipient": {
			"defaultValue": "testemail@microsoft.com",
			"type": "String"
		},
		"EmailSubject": {
			"defaultValue": "Test Subject",
			"type": "String"
		},
		"Email_CC": {
			"defaultValue": "solutions@microsoft.com",
			"type": "String"
		},
		"RunSchedule": {
			"defaultValue": 86400,
			"type": "Int"
		},
		"connections_office365_externalid": {
			"defaultValue": "/subscriptions/634d6794-ca8e-40e6-b5dc-6ecdfe0381c5/resourceGroups/RiskIQSolutions/providers/Microsoft.Web/connections/office365",
			"type": "String"
		}
	},
	"variables": {
		"Office365ConnectionName": "[concat('Office365-', parameters('workflows_MDEASM_EmailAlerts_name'))]"
	},
	"resources": [
		{
			"type": "Microsoft.Web/connections",
			"apiVersion": "2016-06-01",
			"name": "[variables('Office365ConnectionName')]",
			"location": "[resourceGroup().location]",
			"properties": {
				"api": {
					"id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/office365')]"
				}
			}
		},
		{
			"type": "Microsoft.Logic/workflows",
			"apiVersion": "2017-07-01",
			"name": "[parameters('workflows_MDEASM_EmailAlerts_name')]",
			"location": "[resourceGroup().location]",
			"tags": {
				"createdBy": "418 Team",
				"environment": "Dev",
				"user": "Ajay Kallur"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
			],
			"properties": {
				"state": "Disabled",
				"definition": {
					"$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {
						"$connections": {
							"defaultValue": {},
							"type": "Object"
						},
						"EASM API Access Token": {
							"defaultValue": "Bearer Token",
							"type": "String"
						},
						"EASM URI": {
							"defaultValue": "https://southcentralus.easm.defender.microsoft.com/subscriptions/:subscriptionId/resourceGroups/:resourceGroupName/workspaces/:workspaceName/assets",
							"type": "String"
						},
						"EASM query filter": {
							"defaultValue": "state = \"Approved\"",
							"type": "String"
						},
						"EmailRecipient": {
							"defaultValue": "testemail@microsoft.com",
							"type": "String"
						},
						"EmailSubject": {
							"defaultValue": "Test Subject",
							"type": "String"
						},
						"Email_CC": {
							"defaultValue": "solutions@microsoft.com",
							"type": "String"
						},
						"RunSchedule": {
							"defaultValue": 86400,
							"type": "Int"
						}
					},
					"triggers": {
						"Query_EASM_API": {
							"recurrence": {
								"frequency": "Second",
								"interval": "@parameters('RunSchedule')"
							},
							"evaluatedRecurrence": {
								"frequency": "Second",
								"interval": 60
							},
							"type": "Http",
							"inputs": {
								"headers": {
									"Authorization": "@parameters('EASM API Access Token')",
									"Content-Type": "application/json"
								},
								"method": "GET",
								"queries": {
									"api-version": "2022-04-01-preview",
									"filter": "@parameters('EASM API Access Token')",
									"maxpagesize": "@parameters('ResultsSize')",
									"skip": "0"
								},
								"retryPolicy": {
									"count": 10,
									"interval": "PT60S",
									"type": "fixed"
								},
								"uri": "@parameters('EASM URI')"
							},
							"conditions": [
								{
									"expression": "@greater(triggerBody()?.totalElements,0)"
								}
							],
							"runtimeConfiguration": {
								"concurrency": {
									"runs": 25
								}
							}
						}
					},
					"actions": {
						"Send_an_email_with_Office_365": {
							"runAfter": {},
							"type": "ApiConnection",
							"inputs": {
								"body": {
									"Attachments": [
										{
											"ContentBytes": "@{base64(triggerBody())}",
											"Name": "EASMInventory.json"
										}
									],
									"Body": "<p>MD EASM Inventory Assets deatils Attached for your Query, @{parameters('CSV')}<br>\n<br>\n</p>",
									"Cc": "@parameters('Email_CC')",
									"Importance": "Normal",
									"Subject": "@{parameters('EmailSubject')}",
									"To": "@parameters('EmailRecipient')"
								},
								"host": {
									"connection": {
										"name": "@parameters('$connections')['office365']['connectionId']"
									}
								},
								"method": "post",
								"path": "/v2/Mail"
							}
						}
					},
					"outputs": {}
				},
				"parameters": {
					"$connections": {
						"value": {
							"azuresentinel": {
								"connectionId": "[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
								"connectionName": "[variables('Office365ConnectionName')]",
								"id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/office365')]"
							}
						}
					},
					"EASM API Access Token": {
						"value": "[parameters('EASM API Access Token')]"
					},
					"EASM URI": {
						"value": "[parameters('EASM URI')]"
					},
					"EASM query filter": {
						"value": "[parameters('EASM query filter')]"
					},
					"EmailRecipient": {
						"value": "[parameters('EmailRecipient')]"
					},
					"EmailSubject": {
						"value": "[parameters('EmailSubject')]"
					},
					"Email_CC": {
						"value": "[parameters('Email_CC')]"
					},
					"RunSchedule": {
						"value": "[parameters('RunSchedule')]"
					}
				}
			}
		}
	]
}